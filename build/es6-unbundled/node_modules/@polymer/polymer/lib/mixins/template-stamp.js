import"../utils/boot.js";import{dedupingMixin}from"../utils/mixin.js";const templateExtensions={"dom-if":!0,"dom-repeat":!0};function wrapTemplateExtension(a){let b=a.getAttribute("is");if(b&&templateExtensions[b]){let c=a;for(c.removeAttribute("is"),a=c.ownerDocument.createElement(b),c.parentNode.replaceChild(a,c),a.appendChild(c);c.attributes.length;)a.setAttribute(c.attributes[0].name,c.attributes[0].value),c.removeAttribute(c.attributes[0].name)}return a}function findTemplateNode(a,b){let c=b.parentInfo&&findTemplateNode(a,b.parentInfo);if(c){for(let a=c.firstChild,d=0;a;a=a.nextSibling)if(b.parentIndex===d++)return a;}else return a}function applyIdToMap(a,b,c,d){d.id&&(b[d.id]=c)}function applyEventListener(a,b,c){if(c.events&&c.events.length)for(let d,e=0,f=c.events;e<f.length&&(d=f[e]);e++)a._addMethodEventListenerToNode(b,d.name,d.value,a)}function applyTemplateContent(a,b,c){c.templateInfo&&(b._templateInfo=c.templateInfo)}function createNodeEventHandler(a,b,c){a=a._methodHost||a;let d=function(b){a[c]?a[c](b,b.detail):console.warn("listener method `"+c+"` not defined")};return d}export const TemplateStamp=dedupingMixin(a=>{return class extends a{static _parseTemplate(a,b){if(!a._templateInfo){let c=a._templateInfo={};c.nodeInfoList=[],c.stripWhiteSpace=b&&b.stripWhiteSpace||a.hasAttribute("strip-whitespace"),this._parseTemplateContent(a,c,{parent:null})}return a._templateInfo}static _parseTemplateContent(a,b,c){return this._parseTemplateNode(a.content,b,c)}static _parseTemplateNode(a,b,c){let d,e=a;return"template"!=e.localName||e.hasAttribute("preserve-content")?"slot"===e.localName&&(b.hasInsertionPoint=!0):d=this._parseTemplateNestedTemplate(e,b,c)||d,e.firstChild&&(d=this._parseTemplateChildNodes(e,b,c)||d),e.hasAttributes&&e.hasAttributes()&&(d=this._parseTemplateNodeAttributes(e,b,c)||d),d}static _parseTemplateChildNodes(a,b,c){if("script"!==a.localName&&"style"!==a.localName)for(let d,e=a.firstChild,f=0;e;e=d){if("template"==e.localName&&(e=wrapTemplateExtension(e)),d=e.nextSibling,e.nodeType===Node.TEXT_NODE){for(let b=d;b&&b.nodeType===Node.TEXT_NODE;)e.textContent+=b.textContent,d=b.nextSibling,a.removeChild(b),b=d;if(b.stripWhiteSpace&&!e.textContent.trim()){a.removeChild(e);continue}}let g={parentIndex:f,parentInfo:c};this._parseTemplateNode(e,b,g)&&(g.infoIndex=b.nodeInfoList.push(g)-1),e.parentNode&&f++}}static _parseTemplateNestedTemplate(a,b,c){let d=this._parseTemplate(a,b),e=d.content=a.content.ownerDocument.createDocumentFragment();return e.appendChild(a.content),c.templateInfo=d,!0}static _parseTemplateNodeAttributes(b,c,d){let e=!1,f=Array.from(b.attributes);for(let g,a=f.length-1;g=f[a];a--)e=this._parseTemplateNodeAttribute(b,c,d,g.name,g.value)||e;return e}static _parseTemplateNodeAttribute(a,b,c,d,e){return"on-"===d.slice(0,3)?(a.removeAttribute(d),c.events=c.events||[],c.events.push({name:d.slice(3),value:e}),!0):!("id"!==d)&&(c.id=e,!0)}static _contentForTemplate(a){let b=a._templateInfo;return b&&b.content||a.content}_stampTemplate(a){a&&!a.content&&window.HTMLTemplateElement&&HTMLTemplateElement.decorate&&HTMLTemplateElement.decorate(a);let b=this.constructor._parseTemplate(a),c=b.nodeInfoList,d=b.content||a.content,e=document.importNode(d,!0);e.__noInsertionPoint=!b.hasInsertionPoint;let f=e.nodeList=Array(c.length);e.$={};for(let b,d,g=0,h=c.length;g<h&&(b=c[g]);g++)d=f[g]=findTemplateNode(e,b),applyIdToMap(this,e.$,d,b),applyTemplateContent(this,d,b),applyEventListener(this,d,b);return e=e,e}_addMethodEventListenerToNode(a,b,c,d){d=d||a;let e=createNodeEventHandler(d,b,c);return this._addEventListenerToNode(a,b,e),e}_addEventListenerToNode(a,b,c){a.addEventListener(b,c)}_removeEventListenerFromNode(a,b,c){a.removeEventListener(b,c)}}});