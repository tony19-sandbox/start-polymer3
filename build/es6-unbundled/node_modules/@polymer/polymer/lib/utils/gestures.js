import"./boot.js";import{timeOut,microTask}from"./async.js";import{Debouncer}from"./debounce.js";import{passiveTouchGestures}from"./settings.js";let HAS_NATIVE_TA="string"===typeof document.head.style.touchAction,GESTURE_KEY="__polymerGestures",HANDLED_OBJ="__polymerGesturesHandled",TOUCH_ACTION="__polymerGesturesTouchAction",TAP_DISTANCE=25,TRACK_DISTANCE=5,TRACK_LENGTH=2,MOUSE_TIMEOUT=2500,MOUSE_EVENTS=["mousedown","mousemove","mouseup","click"],MOUSE_WHICH_TO_BUTTONS=[0,1,4,2],MOUSE_HAS_BUTTONS=function(){try{return 1===new MouseEvent("test",{buttons:1}).buttons}catch(a){return!1}}();function isMouseEvent(a){return-1<MOUSE_EVENTS.indexOf(a)}let SUPPORTS_PASSIVE=!1;(function(){try{let a=Object.defineProperty({},"passive",{get(){SUPPORTS_PASSIVE=!0}});window.addEventListener("test",null,a),window.removeEventListener("test",null,a)}catch(a){}})();function PASSIVE_TOUCH(a){return isMouseEvent(a)||"touchend"===a?void 0:HAS_NATIVE_TA&&SUPPORTS_PASSIVE&&passiveTouchGestures?{passive:!0}:void 0}let IS_TOUCH_ONLY=navigator.userAgent.match(/iP(?:[oa]d|hone)|Android/),GestureRecognizer=function(){};GestureRecognizer.prototype.reset,GestureRecognizer.prototype.mousedown,GestureRecognizer.prototype.mousemove,GestureRecognizer.prototype.mouseup,GestureRecognizer.prototype.touchstart,GestureRecognizer.prototype.touchmove,GestureRecognizer.prototype.touchend,GestureRecognizer.prototype.click;const clickedLabels=[],labellable={button:!0,input:!0,keygen:!0,meter:!0,output:!0,textarea:!0,progress:!0,select:!0};function canBeLabelled(a){return labellable[a.localName]||!1}function matchingLabels(a){let b=[...(a.labels||[])];if(!b.length){b=[];let c=a.getRootNode();if(a.id){let d=c.querySelectorAll(`label[for = ${a.id}]`);for(let a=0;a<d.length;a++)b.push(d[a])}}return b}let mouseCanceller=function(a){let b=a.sourceCapabilities;if((!b||b.firesTouchEvents)&&(a[HANDLED_OBJ]={skip:!0},"click"===a.type)){let b=!1,c=a.composedPath&&a.composedPath();if(c)for(let a=0;a<c.length;a++){if(c[a].nodeType===Node.ELEMENT_NODE)if("label"===c[a].localName)clickedLabels.push(c[a]);else if(canBeLabelled(c[a])){let d=matchingLabels(c[a]);for(let a=0;a<d.length;a++)b=b||-1<clickedLabels.indexOf(d[a])}if(c[a]===POINTERSTATE.mouse.target)return}if(b)return;a.preventDefault(),a.stopPropagation()}};function setupTeardownMouseCanceller(a){let b=IS_TOUCH_ONLY?["click"]:MOUSE_EVENTS;for(let c,d=0;d<b.length;d++)c=b[d],a?(clickedLabels.length=0,document.addEventListener(c,mouseCanceller,!0)):document.removeEventListener(c,mouseCanceller,!0)}function ignoreMouse(a){POINTERSTATE.mouse.mouseIgnoreJob||setupTeardownMouseCanceller(!0);POINTERSTATE.mouse.target=a.composedPath()[0],POINTERSTATE.mouse.mouseIgnoreJob=Debouncer.debounce(POINTERSTATE.mouse.mouseIgnoreJob,timeOut.after(MOUSE_TIMEOUT),function(){setupTeardownMouseCanceller(),POINTERSTATE.mouse.target=null,POINTERSTATE.mouse.mouseIgnoreJob=null})}function hasLeftMouseButton(a){let b=a.type;if(!isMouseEvent(b))return!1;if("mousemove"===b){let b=void 0===a.buttons?1:a.buttons;return a instanceof window.MouseEvent&&!MOUSE_HAS_BUTTONS&&(b=MOUSE_WHICH_TO_BUTTONS[a.which]||0),!!(1&b)}else{let b=void 0===a.button?0:a.button;return 0===b}}function isSyntheticClick(a){if("click"===a.type){if(0===a.detail)return!0;let b=_findOriginalTarget(a);if(!b.nodeType||b.nodeType!==Node.ELEMENT_NODE)return!0;let c=b.getBoundingClientRect(),d=a.pageX,e=a.pageY;return!(d>=c.left&&d<=c.right&&e>=c.top&&e<=c.bottom)}return!1}let POINTERSTATE={mouse:{target:null,mouseIgnoreJob:null},touch:{x:0,y:0,id:-1,scrollDecided:!1}};function firstTouchAction(a){let b="auto",c=a.composedPath&&a.composedPath();if(c)for(let a,d=0;d<c.length;d++)if(a=c[d],a[TOUCH_ACTION]){b=a[TOUCH_ACTION];break}return b}function trackDocument(a,b,c){a.movefn=b,a.upfn=c,document.addEventListener("mousemove",b),document.addEventListener("mouseup",c)}function untrackDocument(a){document.removeEventListener("mousemove",a.movefn),document.removeEventListener("mouseup",a.upfn),a.movefn=null,a.upfn=null}document.addEventListener("touchend",ignoreMouse,!!SUPPORTS_PASSIVE&&{passive:!0});export const gestures={};export const recognizers=[];export function deepTargetFind(a,b){let c=document.elementFromPoint(a,b),d=c;for(;d&&d.shadowRoot&&!window.ShadyDOM;){let e=d;if(d=d.shadowRoot.elementFromPoint(a,b),e===d)break;d&&(c=d)}return c}export function _findOriginalTarget(a){if(a.composedPath){const b=a.composedPath();return 0<b.length?b[0]:a.target}return a.target}export function _handleNative(a){let b,c=a.type,d=a.currentTarget,e=d[GESTURE_KEY];if(e){let d=e[c];if(d){if(!a[HANDLED_OBJ]&&(a[HANDLED_OBJ]={},"touch"===c.slice(0,5))){a=a;let b=a.changedTouches[0];if("touchstart"===c&&1===a.touches.length&&(POINTERSTATE.touch.id=b.identifier),POINTERSTATE.touch.id!==b.identifier)return;HAS_NATIVE_TA||"touchstart"!==c&&"touchmove"!==c||_handleTouchAction(a)}if(b=a[HANDLED_OBJ],!b.skip){for(let c,e=0;e<recognizers.length;e++)c=recognizers[e],d[c.name]&&!b[c.name]&&c.flow&&-1<c.flow.start.indexOf(a.type)&&c.reset&&c.reset();for(let e,f=0;f<recognizers.length;f++)e=recognizers[f],d[e.name]&&!b[e.name]&&(b[e.name]=!0,e[c](a))}}}}export function _handleTouchAction(a){var b=Math.abs;let c=a.changedTouches[0],d=a.type;if("touchstart"===d)POINTERSTATE.touch.x=c.clientX,POINTERSTATE.touch.y=c.clientY,POINTERSTATE.touch.scrollDecided=!1;else if("touchmove"===d){if(POINTERSTATE.touch.scrollDecided)return;POINTERSTATE.touch.scrollDecided=!0;let d=firstTouchAction(a),e=!1,f=b(POINTERSTATE.touch.x-c.clientX),g=b(POINTERSTATE.touch.y-c.clientY);a.cancelable&&("none"===d?e=!0:"pan-x"===d?e=g>f:"pan-y"===d&&(e=f>g)),e?a.preventDefault():e("track")}}export function addListener(a,b,c){return!!gestures[b]&&(_add(a,b,c),!0)}export function removeListener(a,b,c){return!!gestures[b]&&(_remove(a,b,c),!0)}export function _add(a,b,c){let d=gestures[b],e=d.deps,f=d.name,g=a[GESTURE_KEY];g||(a[GESTURE_KEY]=g={});for(let d,h,j=0;j<e.length;j++)(d=e[j],!(IS_TOUCH_ONLY&&isMouseEvent(d)&&"click"!==d))&&(h=g[d],h||(g[d]=h={_count:0}),0===h._count&&a.addEventListener(d,_handleNative,PASSIVE_TOUCH(d)),h[f]=(h[f]||0)+1,h._count=(h._count||0)+1);a.addEventListener(b,c),d.touchAction&&setTouchAction(a,d.touchAction)}export function _remove(a,b,c){let d=gestures[b],e=d.deps,f=d.name,g=a[GESTURE_KEY];if(g)for(let b,c,d=0;d<e.length;d++)b=e[d],c=g[b],c&&c[f]&&(c[f]=(c[f]||1)-1,c._count=(c._count||1)-1,0===c._count&&a.removeEventListener(b,_handleNative,PASSIVE_TOUCH(b)));a.removeEventListener(b,c)}export function register(a){recognizers.push(a);for(let b=0;b<a.emits.length;b++)gestures[a.emits[b]]=a}export function _findRecognizerByEvent(a){for(let b,c=0;c<recognizers.length;c++){b=recognizers[c];for(let c,d=0;d<b.emits.length;d++)if(c=b.emits[d],c===a)return b}return null}export function setTouchAction(a,b){HAS_NATIVE_TA&&microTask.run(()=>{a.style.touchAction=b}),a[TOUCH_ACTION]=b}export function _fire(a,b,c){let d=new Event(b,{bubbles:!0,cancelable:!0,composed:!0});if(d.detail=c,a.dispatchEvent(d),d.defaultPrevented){let a=c.preventer||c.sourceEvent;a&&a.preventDefault&&a.preventDefault()}}export function prevent(a){let b=_findRecognizerByEvent(a);b.info&&(b.info.prevent=!0)}export function resetMouseCanceller(){POINTERSTATE.mouse.mouseIgnoreJob&&POINTERSTATE.mouse.mouseIgnoreJob.flush()}register({name:"downup",deps:["mousedown","touchstart","touchend"],flow:{start:["mousedown","touchstart"],end:["mouseup","touchend"]},emits:["down","up"],info:{movefn:null,upfn:null},reset:function(){untrackDocument(this.info)},mousedown:function(a){if(!hasLeftMouseButton(a))return;let b=_findOriginalTarget(a),c=this;trackDocument(this.info,function(a){hasLeftMouseButton(a)||(c._fire("up",b,a),untrackDocument(c.info))},function(a){hasLeftMouseButton(a)&&c._fire("up",b,a),untrackDocument(c.info)}),this._fire("down",b,a)},touchstart:function(a){this._fire("down",_findOriginalTarget(a),a.changedTouches[0],a)},touchend:function(a){this._fire("up",_findOriginalTarget(a),a.changedTouches[0],a)},_fire:function(a,b,c,d){_fire(b,a,{x:c.clientX,y:c.clientY,sourceEvent:c,preventer:d,prevent:function(a){return prevent(a)}})}}),register({name:"track",touchAction:"none",deps:["mousedown","touchstart","touchmove","touchend"],flow:{start:["mousedown","touchstart"],end:["mouseup","touchend"]},emits:["track"],info:{x:0,y:0,state:"start",started:!1,moves:[],addMove:function(a){this.moves.length>TRACK_LENGTH&&this.moves.shift(),this.moves.push(a)},movefn:null,upfn:null,prevent:!1},reset:function(){this.info.state="start",this.info.started=!1,this.info.moves=[],this.info.x=0,this.info.y=0,this.info.prevent=!1,untrackDocument(this.info)},hasMovedEnough:function(a,b){var c=Math.abs;if(this.info.prevent)return!1;if(this.info.started)return!0;let d=c(this.info.x-a),e=c(this.info.y-b);return d>=TRACK_DISTANCE||e>=TRACK_DISTANCE},mousedown:function(a){if(!hasLeftMouseButton(a))return;let b=_findOriginalTarget(a),c=this,d=function(a){let d=a.clientX,e=a.clientY;c.hasMovedEnough(d,e)&&(c.info.state=c.info.started?"mouseup"===a.type?"end":"track":"start","start"===c.info.state&&prevent("tap"),c.info.addMove({x:d,y:e}),!hasLeftMouseButton(a)&&(c.info.state="end",untrackDocument(c.info)),c._fire(b,a),c.info.started=!0)};trackDocument(this.info,d,function(a){c.info.started&&d(a),untrackDocument(c.info)}),this.info.x=a.clientX,this.info.y=a.clientY},touchstart:function(a){let b=a.changedTouches[0];this.info.x=b.clientX,this.info.y=b.clientY},touchmove:function(a){let b=_findOriginalTarget(a),c=a.changedTouches[0],d=c.clientX,e=c.clientY;this.hasMovedEnough(d,e)&&("start"===this.info.state&&prevent("tap"),this.info.addMove({x:d,y:e}),this._fire(b,c),this.info.state="track",this.info.started=!0)},touchend:function(a){let b=_findOriginalTarget(a),c=a.changedTouches[0];this.info.started&&(this.info.state="end",this.info.addMove({x:c.clientX,y:c.clientY}),this._fire(b,c,a))},_fire:function(a,b){let c,d=this.info.moves[this.info.moves.length-2],e=this.info.moves[this.info.moves.length-1],f=e.x-this.info.x,g=e.y-this.info.y,h=0;d&&(c=e.x-d.x,h=e.y-d.y),_fire(a,"track",{state:this.info.state,x:b.clientX,y:b.clientY,dx:f,dy:g,ddx:c,ddy:h,sourceEvent:b,hover:function(){return deepTargetFind(b.clientX,b.clientY)}})}}),register({name:"tap",deps:["mousedown","click","touchstart","touchend"],flow:{start:["mousedown","touchstart"],end:["click","touchend"]},emits:["tap"],info:{x:NaN,y:NaN,prevent:!1},reset:function(){this.info.x=NaN,this.info.y=NaN,this.info.prevent=!1},save:function(a){this.info.x=a.clientX,this.info.y=a.clientY},mousedown:function(a){hasLeftMouseButton(a)&&this.save(a)},click:function(a){hasLeftMouseButton(a)&&this.forward(a)},touchstart:function(a){this.save(a.changedTouches[0],a)},touchend:function(a){this.forward(a.changedTouches[0],a)},forward:function(a,b){var c=Math.abs;let d=c(a.clientX-this.info.x),e=c(a.clientY-this.info.y),f=_findOriginalTarget(b||a);!f||f.disabled||(isNaN(d)||isNaN(e)||d<=TAP_DISTANCE&&e<=TAP_DISTANCE||isSyntheticClick(a))&&!this.info.prevent&&_fire(f,"tap",{x:a.clientX,y:a.clientY,sourceEvent:a,preventer:b})}});export const findOriginalTarget=_findOriginalTarget;export const add=addListener;export const remove=removeListener;