import"./boot.js";import{PropertyEffects}from"../mixins/property-effects.js";import{MutableData}from"../mixins/mutable-data.js";let newInstance=null;function HTMLTemplateElementExtension(){return newInstance}HTMLTemplateElementExtension.prototype=Object.create(HTMLTemplateElement.prototype,{constructor:{value:HTMLTemplateElementExtension,writable:!0}});const DataTemplate=PropertyEffects(HTMLTemplateElementExtension),MutableDataTemplate=MutableData(DataTemplate);function upgradeTemplate(a,b){newInstance=a,Object.setPrototypeOf(a,b.prototype),new b,newInstance=null}const base=PropertyEffects(class{});class TemplateInstanceBase extends base{constructor(a){super(),this._configureProperties(a),this.root=this._stampTemplate(this.__dataHost);let b=this.children=[];for(let c=this.root.firstChild;c;c=c.nextSibling)b.push(c),c.__templatizeInstance=this;this.__templatizeOwner&&this.__templatizeOwner.__hideTemplateChildren__&&this._showHideChildren(!0);let c=this.__templatizeOptions;(a&&c.instanceProps||!c.instanceProps)&&this._enableProperties()}_configureProperties(a){let b=this.__templatizeOptions;if(b.forwardHostProp)for(let a in this.__hostProps)this._setPendingProperty(a,this.__dataHost["_host_"+a]);for(let b in a)this._setPendingProperty(b,a[b])}forwardHostProp(a,b){this._setPendingPropertyOrPath(a,b,!1,!0)&&this.__dataHost._enqueueClient(this)}_addEventListenerToNode(a,b,c){if(this._methodHost&&this.__templatizeOptions.parentModel)this._methodHost._addEventListenerToNode(a,b,a=>{a.model=this,c(a)});else{let d=this.__dataHost.__dataHost;d&&d._addEventListenerToNode(a,b,c)}}_showHideChildren(a){let b=this.children;for(let c,d=0;d<b.length;d++){if(c=b[d],!!a!=!!c.__hideTemplateChildren__)if(c.nodeType===Node.TEXT_NODE)a?(c.__polymerTextContent__=c.textContent,c.textContent=""):c.textContent=c.__polymerTextContent__;else if("slot"!==c.localName)c.style&&(a?(c.__polymerDisplay__=c.style.display,c.style.display="none"):c.style.display=c.__polymerDisplay__);else if(a)c.__polymerReplaced__=document.createComment("hidden-slot"),c.parentNode.replaceChild(c.__polymerReplaced__,c);else{const a=c.__polymerReplaced__;a&&a.parentNode.replaceChild(c,a)}c.__hideTemplateChildren__=a,c._showHideChildren&&c._showHideChildren(a)}}_setUnmanagedPropertyToNode(a,b,c){a.__hideTemplateChildren__&&a.nodeType==Node.TEXT_NODE&&"textContent"==b?a.__polymerTextContent__=c:super._setUnmanagedPropertyToNode(a,b,c)}get parentModel(){let a=this.__parentModel;if(!a){let b;a=this;do a=a.__dataHost.__dataHost;while((b=a.__templatizeOptions)&&!b.parentModel);this.__parentModel=a}return a}dispatchEvent(){return!0}}TemplateInstanceBase.prototype.__dataHost,TemplateInstanceBase.prototype.__templatizeOptions,TemplateInstanceBase.prototype._methodHost,TemplateInstanceBase.prototype.__templatizeOwner,TemplateInstanceBase.prototype.__hostProps;const MutableTemplateInstanceBase=MutableData(TemplateInstanceBase);function findMethodHost(a){let b=a.__dataHost;return b&&b._methodHost||b}function createTemplatizerClass(a,b,c){let d=c.mutableData?MutableTemplateInstanceBase:TemplateInstanceBase,e=class extends d{};return e.prototype.__templatizeOptions=c,e.prototype._bindTemplate(a),addNotifyEffects(e,a,b,c),e}function addPropagateEffects(a,b,c){let d=c.forwardHostProp;if(d){let e=b.templatizeTemplateClass;if(!e){let a=c.mutableData?MutableDataTemplate:DataTemplate;e=b.templatizeTemplateClass=class extends a{};let f=b.hostProps;for(let a in f)e.prototype._addPropertyEffect("_host_"+a,e.prototype.PROPERTY_EFFECT_TYPES.PROPAGATE,{fn:createForwardHostPropEffect(a,d)}),e.prototype._createNotifyingProperty("_host_"+a)}upgradeTemplate(a,e),a.__dataProto&&Object.assign(a.__data,a.__dataProto),a.__dataTemp={},a.__dataPending=null,a.__dataOld=null,a._enableProperties()}}function createForwardHostPropEffect(a,b){return function(a,c,d){b.call(a.__templatizeOwner,c.substring(6),d[c])}}function addNotifyEffects(a,b,c,d){let e=c.hostProps||{};for(let f in d.instanceProps){delete e[f];let b=d.notifyInstanceProp;b&&a.prototype._addPropertyEffect(f,a.prototype.PROPERTY_EFFECT_TYPES.NOTIFY,{fn:createNotifyInstancePropEffect(f,b)})}if(d.forwardHostProp&&b.__dataHost)for(let b in e)a.prototype._addPropertyEffect(b,a.prototype.PROPERTY_EFFECT_TYPES.NOTIFY,{fn:createNotifyHostPropEffect()})}function createNotifyInstancePropEffect(a,b){return function(a,c,d){b.call(a.__templatizeOwner,a,c,d[c])}}function createNotifyHostPropEffect(){return function(a,b,c){a.__dataHost._setPendingPropertyOrPath("_host_"+b,c[b],!0,!0)}}export function templatize(a,b,c){if(c=c||{},a.__templatizeOwner)throw new Error("A <template> can only be templatized once");a.__templatizeOwner=b;const d=b?b.constructor:TemplateInstanceBase;let e=d._parseTemplate(a),f=e.templatizeInstanceClass;f||(f=createTemplatizerClass(a,e,c),e.templatizeInstanceClass=f),addPropagateEffects(a,e,c);let g=class extends f{};return g.prototype._methodHost=findMethodHost(a),g.prototype.__dataHost=a,g.prototype.__templatizeOwner=b,g.prototype.__hostProps=e.hostProps,g=g,g}export function modelForElement(a,b){for(let c;b;)if(!(c=b.__templatizeInstance))b=b.parentNode;else if(c.__dataHost!=a)b=c.__dataHost;else return c;return null}export{TemplateInstanceBase};